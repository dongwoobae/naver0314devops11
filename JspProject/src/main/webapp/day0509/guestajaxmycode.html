<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<!--????????-->
<!-- Latest compiled and minified CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<!-- Latest compiled JavaScript -->
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!--???-->
<link
	href="https://fonts.googleapis.com/css2?family=Dokdo&family=Dongle&family=Gaegu&family=Gowun+Batang&family=Reem+Kufi+Fun:wght@400..700&family=Song+Myung&family=Dancing+Script&family=Tilt+Neon&display=swap"
	rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">

<style>
body * {
	font-family: "Gowun Batang";
	margin-bottom: 5px;
}

div.guestlist div.box {
	width: 400px;
	padding: 10px;
	border: 1px solid gray;
	border-radius: 10px;
	margin-bottom: 10px;
}

div.guestlist div.box img {
	width: 50px;
	margin-right: 5px;
}

div.guestlist div.box a {
	color: gray;
	text-decoration: none;
	cursor: pointer;
}
</style>
<script type="text/javascript">
$(function(){
	list();//처음 로딩시 일단 목록 출력
	
	//db 저장 버튼 이벤트
	$("#btnsave").click(function(){
		//입력체크
		let avatar=$("#selavatar").val();
		let nickname=$("#nickname").val();
		let content=$("#content").val();
		
		if(nickname.length==0){
			alert("닉네임을 입력해주세요");
			return;
		}
		
		if(content.length==0){
			alert("내용을 입력해주세요");
			return;
		}
		
		$.ajax({
			type:"post",
			datatype:"html",
			url:"./data/insertdata.jsp",
			//data:"avatar="+avatar+"&nickname="+nickname+"&content="+content,
			data:{"avatar":avatar,"nickname":nickname,"content":content},
			success:function(){
				//데이터 성공 추가 후 해야할 일들
				list();//목록 다시 출력
				//입력값을 초기화
				$("#selavatar").prop("selectedIndex",0);
				$("#nickname").val("");
				$("#content").val("");
				$(".avatar").attr("src","../image/snoopyAvata/s1.JPG");
			}
		})
	});
	
	$("#btnsearch").click(function(){
		list();
	});
	
	$("div.guestlist").on("click","a.adel",function(e){
		e.preventDefault();
		let a = confirm("삭제 확인");
		//클릭한 곳의 num을 읽기
		let num=$(this).attr("num");
		if(a){
			$.ajax({
				type:"get",
				dataType:"html",
				url:"./data/deletedata.jsp",
				data:{"num":num},
				success:function(){
					//삭제성공후
					list();//목록 다시 출력
				}
			})
		}
	});
	//수정 이벤트
	$(document).on("click","a.amod",function(e){
		e.preventDefault();
		//num 가져오기
		let num = $(this).attr("num");
		//백엔드에서 num에 해당하는 dto 가져오기
		$.ajax({
			type:"get",
			dataType:"json",
			data:{"num":num},
			url:"./data/updatedata.jsp",
			success:function(data){
				$("#nicknameModal").val(data.nickname);
				$("#contentModal").val(data.content);
				$("#numModal").text(data.num);
			}
		});
	});
	
	$("#modifyModal").click(function(){
		//보낼 데이터 뽑기
		let num=$("#numModal").text();
		let content=$("#contentModal").val();
		let nickname=$("#nicknameModal").val();
		
		$.ajax({
			type:"get",
			dataType:"html",
			data:{"num":num,"nickname":nickname,"content":content},
			url:"./data/update.jsp",
			success:function(){
				$("#closeModal").trigger("click");
				list();			
			}
		});
	});
});//end function

function list(){
	$("div.guestlist").empty();
	let search=$("#search").val();
	
	$.ajax({
		
		type:"get",
		dataType:"json",
		data:{"search":search},
		url:"./data/listdata.jsp",
		success:function(data){
			let s="";
			s+=`
			총 ${data.length}개의 방명록 글이 있습니다<br>`;
			
			$.each(data,function(idx,ele){
				s+=`
				<div class="box">
					<img src="${ele.avatar}">
					<b>${ele.nickname}</b>
					<span style="float:right;">
						<a class="amod" num="${ele.num}"
							data-bs-toggle="modal" data-bs-target="#myModalUpdate">수정</a>
						/
						<a class="adel" num="${ele.num}">삭제</a>
					</span>
					<br>
					<span style="color:gray;font-size:12px;">
					${ele.writeday}</span>
					<br><pre style="background-color:rgba(0,0,0,0.1)">${ele.content}</pre>
					
				</div>
				`;
			});
			
			$("div.guestlist").html(s);
		}
	})
}
</script>
</head>
<body>
	<!-- Modal -->
	<!-- The Modal : 수정시 호출되는 모달다이얼로그-->
	<div class="modal" id="myModalUpdate">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
			
				<!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">방명록 수정</h4>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>

				<!-- Modal body -->
				<div class="modal-body">
				<h6>닉네임</h6>
				<input type="text" id="nicknameModal">
				<h6>내용</h6>
				<textarea id="contentModal"></textarea>
				<input type="text" id="numModal" hidden>
				</div>

				<!-- Modal footer -->
				<div class="modal-footer">
					<button type="button" class="btn btn-info" id="modifyModal">수정</button>
					<button type="button" class="btn btn-danger"
						data-bs-dismiss="modal" id="closeModal">취소</button>
				</div>

			</div>
		</div>
	</div>
	<div style="margin: 10px; width: 400px;">
		<h5 class="alert alert-info">방명록</h5>
		<div class="inputform">
			<div class="input-group">
				<select class="form-select" id="selavatar">
					<script type="text/javascript">
						for(let i=1;i<=10;i++){
							document.write(`<option value="../image/snoopyAvata/s${i}.JPG">
							아바타 #${i}</option>`);
						}
					</script>
				</select> <img src="../image/snoopyAvata/s1.JPG" width="40" class="avatar">
				<script type="text/javascript">
				$("#selavatar").change(function(){
					$(".avatar").attr("src",$(this).val());
				});
				</script>
				<input type="text" id="nickname" class="form-control"
					placeholder="닉네임입력">
				<button type="button" class="btn btn-sm btn-success" id="btnsave">DB
					저장</button>
			</div>
			<textarea id="content" style="width: 100%; height: 100px;"
				placeholder="내용을 입력하세요"></textarea>
			<hr>
			<!-- 검색 -->
			<div class="input-group" style="margin-left: 100px; width: 300px;">
				<b>닉네임 검색</b> <input type="text" id="search" class="form-control"
					style="margin-left: 10px;">
				<button type="button" class="btn btn-sm btn-info" id="btnsearch">검색</button>
			</div>
			<div class="guestlist">111</div>
		</div>
	</div>
</body>
</html>